# 简报：微信云托管迁移 — 代码改造

**时间**：2026-02-13

## 完成内容

### 新建文件
- `server/Dockerfile` — 基于 node:18-alpine，端口 80，生产依赖安装
- `server/.dockerignore` — 排除 node_modules、.env、uploads 等

### 修改文件

**`miniprogram/utils/api.js`**
- `BASE_URL` 根据 `__wxConfig.envVersion` 自动切换（开发版 → localhost:3000，体验版/正式版 → 云托管域名）
- 新增 `getImageUrl(path)` — 相对路径转完整 URL，已有完整 URL 直接返回
- 新增 `processGameUrls(game)` — 自动处理游戏对象中所有图片/视频 URL（coverImage、images、videos）
- `getGames`、`getGameDetail`、`getRandomGame` 返回数据自动经过 `processGameUrls` 处理，wxml 模板无需改动

**`miniprogram/pages/index/index.js`**
- Canvas 图片加载从硬编码 `http://localhost:3000` 改为 `api.getImageUrl()`

**`server/src/routes/upload.js`**
- 图片/视频上传返回相对路径（`/uploads/images/xxx`）而非硬编码完整 URL

## 待办
- 部署时将 `api.js` 第 9 行的 `https://your-cloud-host.com` 替换为实际云托管域名
- 云托管控制台配置环境变量（MONGODB_URI、JWT_SECRET、WX_APPID、WX_SECRET）
- 配置持久化存储卷挂载到 `/app/uploads`
