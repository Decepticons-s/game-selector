# 阶段二：核心功能开发 - 详细实施计划

## 目标
实现小程序的核心用户功能，包括转盘抽取、游戏详情展示、游戏列表浏览和人数筛选。

---

## 1. 转盘组件开发

### 1.1 创建转盘组件
**文件位置**: `miniprogram/components/wheel/`

**功能需求**:
- 使用Canvas绘制转盘
- 支持动态扇形数量（根据游戏数量）
- 显示游戏名称
- 实现旋转动画
- 支持指针指向效果

**实现要点**:

#### 1.1.1 组件结构
创建标准小程序组件结构，包含js、json、wxml、wxss四个文件

#### 1.1.2 Canvas绘制逻辑
- 计算每个扇形的角度：`360° / 游戏数量`
- 绘制扇形背景（交替使用不同颜色）
- 在扇形上绘制游戏名称文字
- 绘制中心圆和指针
- 处理文字过长的截断显示

#### 1.1.3 旋转动画
- 使用`requestAnimationFrame`实现平滑动画
- 缓动函数：先加速后减速（easeOutCubic）
- 旋转时长：3-5秒
- 随机旋转圈数：3-5圈 + 目标角度
- 动画结束后触发回调，返回选中的游戏

#### 1.1.4 组件属性
- `games`: 游戏列表数组
- `spinning`: 是否正在旋转的布尔值

#### 1.1.5 组件事件
- `startSpin()`: 开始旋转，接收目标索引参数
- `onSpinEnd()`: 旋转结束，触发spinend事件并传递选中的游戏对象

### 1.2 首页集成转盘
**文件位置**: `miniprogram/pages/index/`

**功能需求**:
- 人数选择器
- 开始抽取按钮
- 显示抽取结果
- 跳转到游戏详情

**实现要点**:

#### 1.2.1 页面布局
- 人数选择器（picker组件）
- 转盘组件（自定义wheel组件）
- 开始抽取按钮（旋转时禁用）
- 结果展示区域（显示抽中的游戏名称和查看详情按钮）

#### 1.2.2 数据管理
- `playerCounts`: 人数选项数组 [2, 3, 4, 5, 6, 7, 8, '8+']
- `selectedPlayerIndex`: 当前选中的人数索引，默认4人
- `allGames`: 从API加载的所有游戏列表
- `filteredGames`: 根据人数筛选后的游戏列表
- `selectedGame`: 抽中的游戏对象
- `spinning`: 是否正在旋转的状态标志

#### 1.2.3 人数筛选逻辑
- 监听picker的change事件，更新选中的人数
- 根据选中人数过滤游戏列表
- 对于"8+"选项，筛选最大人数≥8的游戏
- 对于具体人数，筛选min≤人数≤max的游戏

#### 1.2.4 抽取逻辑
- 检查筛选后的游戏列表是否为空
- 随机选择一个游戏索引
- 调用转盘组件的startSpin方法开始旋转
- 监听spinend事件获取结果
- 提供跳转到详情页的功能

---

## 2. 游戏详情页开发

### 2.1 页面结构
**文件位置**: `miniprogram/pages/detail/`

**功能需求**:
- 显示游戏封面图
- 显示游戏基本信息（名称、人数、时长、难度）
- 显示游戏描述
- 显示游戏图片轮播
- 播放游戏视频（如果有）
- 返回和再抽一次按钮

### 2.2 页面布局
- 封面图（全宽显示）
- 基本信息区域（游戏名称、人数、时长、难度）
- 游戏介绍区域（文字描述）
- 图片轮播区域（swiper组件，支持图片预览）
- 视频播放区域（video组件）
- 底部操作按钮（返回、再抽一次）

### 2.3 页面逻辑
- 从URL参数获取游戏ID
- 调用API加载游戏详情
- 实现图片预览功能（wx.previewImage）
- 处理加载状态和错误提示
- 实现返回和重新抽取功能

### 2.4 样式设计要点
- 封面图高度500rpx，aspectFill模式
- 信息区域使用卡片式布局，白色背景
- 元数据信息横向排列，居中对齐
- 图片轮播高度400rpx，显示指示点
- 底部按钮固定定位，带阴影效果

---

## 3. 游戏列表页开发

### 3.1 页面结构
**文件位置**: `miniprogram/pages/list/`

**功能需求**:
- 显示所有游戏列表
- 支持按人数筛选
- 支持搜索功能
- 点击进入详情页

### 3.2 页面布局
- 搜索栏（input组件）
- 筛选器（picker组件，选择人数）
- 游戏列表（scroll-view，卡片式展示）
- 空状态提示

### 3.3 页面逻辑
- 页面加载时获取所有游戏
- 实现搜索功能（按游戏名称模糊匹配）
- 实现人数筛选功能
- 支持搜索和筛选组合使用
- 点击游戏卡片跳转��详情页

### 3.4 游戏卡片设计
- 左侧：游戏封面缩略图（150rpx × 150rpx）
- 右侧：游戏信息
  - 游戏名称（加粗）
  - 人数和时长（灰色小字）
  - 难度标签

### 3.5 筛选逻辑
- 搜索过滤���游戏名称包含关键词（不区分大小写）
- 人数过滤：与首页相同的逻辑
- 两个过滤条件同时生效

---

## 4. API工具类完善

### 4.1 添加游戏相关API
**文件位置**: `miniprogram/utils/api.js`

需要添加的方法：
- `getGames()`: 获取所有游戏列表
- `getGameById(id)`: 根据ID获取游戏详情
- `getGamesByPlayerCount(count)`: 根据人数筛选游戏（可选，前端筛选也可以）

### 4.2 错误处理
- 统一处理网络错误
- 统一处理401未授权错误
- 提供友好的错误提示

---

## 5. 导航配置

### 5.1 更新app.json
**文件位置**: `miniprogram/app.json`

**配置内容**:
- 页面路径配置（index、detail、list）
- TabBar配置（抽取、列表、管理）
- 窗口样式配置

### 5.2 TabBar图标准备
需要准备的图标（每个2个状态）：
- 转盘图标（wheel.png / wheel-active.png）
- 列表图标（list.png / list-active.png）
- 管理图标（admin.png / admin-active.png）

图标规格：81px × 81px，PNG格式

---

## 6. 测试计划

### 6.1 功能测试

#### 转盘功能
- [ ] 转盘正确绘制（扇形、文字、指针）
- [ ] 旋转动画流畅
- [ ] 随机结果正确
- [ ] 人数筛选后游戏数量正确
- [ ] 无游戏时提示正确

#### 详情页
- [ ] 游戏信息完整显示
- [ ] 图片轮播正常
- [ ] 视频播放正常
- [ ] 图片预览功能正常
- [ ] 返回和再抽一次按钮正常

#### 列表页
- [ ] 游戏列表正确显示
- [ ] 搜索功能正常
- [ ] 人数筛选正常
- [ ] 点击跳转详情正常
- [ ] 空状态显示正常

### 6.2 兼容性测试
- [ ] iOS真机测试
- [ ] Android真机测试
- [ ] 不同屏幕尺寸适配（iPhone SE、iPhone 14 Pro Max、iPad）

### 6.3 性能测试
- [ ] 转盘动画帧率 > 30fps
- [ ] 页面加载时间 < 2秒
- [ ] 图片加载优化（懒加载）
- [ ] 列表滚动流畅度

### 6.4 边界情况测试
- [ ] 游戏数量为0时的处理
- [ ] 游戏数量为1时的转盘显示
- [ ] 游戏数量超过20时的处理
- [ ] 网络断开时的错误提示
- [ ] 图片加载失败的占位图

---

## 7. 开发时间估算

| 任务 | 预计时间 | 优先级 |
|------|---------|--------|
| 转盘组件开发 | 2天 | 高 |
| 首页集成 | 1天 | 高 |
| 游戏详情页 | 1天 | 高 |
| 游戏列表页 | 1天 | 中 |
| API完善 | 0.5天 | 高 |
| TabBar图标准备 | 0.5天 | 中 |
| 测试和调试 | 1.5天 | 高 |
| **总计** | **7.5天** | - |

---

## 8. 验收标准

### 8.1 功能完整性
- ✅ 用户可以选择人数
- ✅ 用户可以通过转盘抽取游戏
- ✅ 用户可以查看游戏详情
- ✅ 用户可以浏览游戏列表
- ✅ 用户可以搜索和筛选游戏

### 8.2 用户体验
- ✅ 转盘动画流畅自然
- ✅ 页面加载速度快
- ✅ 交互反馈及时
- ✅ 界面美观易用
- ✅ 错误提示友好

### 8.3 代码质量
- ✅ 代码结构清晰
- ✅ 组件复用性好
- ✅ 错误处理完善
- ✅ 注释充分

---

## 9. 技术难点和解决方案

### 9.1 转盘性能优化
**问题**: 游戏数量多时，Canvas绘制可能卡顿

**解决方案**:
- 使用离屏Canvas预渲染
- 限制转盘最多显示20个游戏
- 超过20个时随机选择20个展示

### 9.2 转盘文字显示
**问题**: 游戏名称过长时显示不全

**解决方案**:
- 限制文字长度，超过部分用省略号
- 根据扇形大小动态调整字体大小
- 考虑使用缩写或简称

### 9.3 图片加载优化
**问题**: 详情页图片过多导致加载慢

**解决方案**:
- 使用图片懒加载
- 提供图片占位符
- 压缩图片质量

### 9.4 列表性能
**问题**: 游戏列表过长时滚动卡顿

**解决方案**:
- 使用虚拟列表（如果游戏数量>100）
- 图片懒加载
- 避免在scroll事件中进行复杂计算

---

## 10. 下一步计划

阶段二完成后，进入**阶段三：管理后台开发**，包括：
- 管理员登录功能
- 游戏增删改查功能
- 图片和视频上传功能
- 游戏数据管理

---

## 11. 关键技术参考

### 11.1 Canvas转盘绘制
- 使用`wx.createCanvasContext()`创建画布上下文
- 使用`arc()`方法绘制扇形
- 使用`rotate()`实现旋转效果
- 使用`requestAnimationFrame()`实现动画

### 11.2 缓动函数
- easeOutCubic: 先快后慢的缓动效果
- 公式: `1 - Math.pow(1 - t, 3)`
- 适合转盘减速停止的效果

### 11.3 图片预加载
- 使用`wx.createImage()`创建图片对象
- 监听`onload`事件确保图片加载完成
- 在转盘绘制前预加载所有游戏封面

### 11.4 微信小程序API
- `wx.navigateTo()`: 跳转到详情页
- `wx.navigateBack()`: 返回上一页
- `wx.previewImage()`: 预览图片
- `wx.showLoading()` / `wx.hideLoading()`: 显示/隐藏加载提示
- `wx.showToast()`: 显示消息提示

---

## 附录：文件清单

### 需要创建的文件

**组件**:
- `miniprogram/components/wheel/wheel.js`
- `miniprogram/components/wheel/wheel.json`
- `miniprogram/components/wheel/wheel.wxml`
- `miniprogram/components/wheel/wheel.wxss`

**页面**:
- `miniprogram/pages/index/index.js`
- `miniprogram/pages/index/index.json`
- `miniprogram/pages/index/index.wxml`
- `miniprogram/pages/index/index.wxss`
- `miniprogram/pages/detail/detail.js`
- `miniprogram/pages/detail/detail.json`
- `miniprogram/pages/detail/detail.wxml`
- `miniprogram/pages/detail/detail.wxss`
- `miniprogram/pages/list/list.js`
- `miniprogram/pages/list/list.json`
- `miniprogram/pages/list/list.wxml`
- `miniprogram/pages/list/list.wxss`

**图标资源**:
- `miniprogram/images/wheel.png`
- `miniprogram/images/wheel-active.png`
- `miniprogram/images/list.png`
- `miniprogram/images/list-active.png`
- `miniprogram/images/admin.png`
- `miniprogram/images/admin-active.png`

**配置文件**:
- `miniprogram/app.json` (更新)
- `miniprogram/utils/api.js` (更新)

---

## 12. 实际实施记录（2026-02-09）

### 12.1 设计方案调整

在实际开发过程中，根据 Figma 设计稿（https://www.figma.com/make/LvbLDsIzVlFIYq1dpliIzW/Game-Draw-Mini-Program-Page）对原计划进行了重大调整：

**原计划**：使用 Canvas 绘制转盘，实现旋转动画
**实际实现**：使用 3D 翻转卡片效果，简化交互流程

**调整原因**：
1. Figma 设计稿采用现代简洁的卡片翻转设计，比转盘更符合当前设计趋势
2. 3D 翻转效果在微信小���序中实现更简单，性能更好
3. 卡片翻转的交互更直观，用户体验更好

### 12.2 视觉风格改造

#### 12.2.1 配色方案
- **背景色**：从紫色渐变（#667eea → #764ba2）改为灰白色渐变（#f9fafb → #ffffff → #f9fafb）
- **强调色**：采用蓝紫色渐变（#3b82f6 → #8b5cf6）
- **文字颜色**：
  - 主标题：#111827
  - 副标题/说明文字：#6b7280
  - 占位文字：#9ca3af

#### 12.2.2 设计系统
- **圆角系统**：
  - 小圆角：12rpx, 20rpx
  - 中圆角：24rpx, 48rpx
  - 大圆角：100rpx（胶囊形状）

- **阴影系统**：
  - 小阴影：`0 4rpx 16rpx rgba(0, 0, 0, 0.06)`
  - 中阴影：`0 8rpx 32rpx rgba(0, 0, 0, 0.08)`
  - 彩色阴影：`0 8rpx 24rpx rgba(59, 130, 246, 0.3)`

- **间距系统**：24rpx, 32rpx, 40rpx, 48rpx, 60rpx

- **字体系统**：
  - 标题：48-56rpx, font-weight: 600
  - 正文：28-32rpx, font-weight: 400-500
  - 小字：24rpx
  - 字间距：letter-spacing: -0.5rpx

### 12.3 主页面改造（pages/index）

#### 12.3.1 布局变更
- 标题从"今天玩什么？"改为"游戏抽取器"
- 副标题更新为"输入玩家人数，随机抽取适合的游戏"
- 移除"开始抽取"按钮，改为点击卡片触发抽取
- 添加"重新抽取"按钮，仅在翻转后显示

#### 12.3.2 输入框重设计
- 采用圆角胶囊样式（border-radius: 100rpx）
- 白色背景，带边框（2rpx solid #e5e7eb）和阴影
- 输入框居中显示，字体更大（40rpx）
- 添加"人"单位提示
- 图标和输入框在同一行

#### 12.3.3 卡片翻转效果实现

**技术实现**：
```css
.wheel-container {
  perspective: 2000rpx;  /* 设置透视距离 */
}

.game-card {
  transform-style: preserve-3d;  /* 保持3D空间 */
  transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.game-card.flipped {
  transform: rotateY(180deg);  /* 翻转180度 */
}

.card-face {
  backface-visibility: hidden;  /* 隐藏背面 */
}

.card-back {
  transform: rotateY(180deg);  /* 背面预先翻转 */
}
```

**卡片正面**：
- 灰白色渐变背景
- 中央显示游戏手柄图标（🎮）
- 白色圆形图标容器
- 问号占位符

**卡片背面**：
- 蓝紫色渐变背景
- 显示游戏名称（48rpx, font-weight: 600）
- 显示游戏描述（28rpx, 半透明白色）
- 显示玩家人数和游戏时长（带图标 👥 ⏱️）

#### 12.3.4 交互流程优化
1. 用户输入玩家人数
2. 点击卡片触发抽取
3. 验证人数有效性
4. 筛选符合人数的游戏
5. 随机选择一个游戏
6. 延迟 300ms 后卡片翻转
7. 显示抽取结果
8. 显示"重新抽取"按钮

**移除的功能**：
- Canvas 转盘绘制
- 转盘旋转动画
- 弹窗提示（wx.showModal）
- "开始抽取"按钮

**简化的状态管理**：
- 移除 `spinning` 状态
- 移除 `rotation` 状态
- 新增 `isRevealed` 状态（控制卡片翻转）

### 12.4 列表页改造（pages/list）

**主要更新**：
- 背景改为灰白色渐变
- 筛选框采用圆角胶囊样式
- 游戏卡片增加边框和阴影
- 标签颜色从橙色（#FFE5DC / #FF6B35）改为蓝色（#eff6ff / #3b82f6）
- 字体颜色更新为新的配色方案
- 增加卡片间距（24rpx）

### 12.5 详情页改造（pages/detail）

**主要更新**：
- 背景改为灰白色渐变
- 元数据卡片增加边框和阴影
- 标签采用蓝紫色渐变背景，带彩色阴影
- 所有内容区块增加边框（2rpx solid #e5e7eb）和阴影
- 底部按钮采用蓝紫色渐变背景，圆角胶囊样式
- 字体颜色更新为新的配色方案
- 增加内边距和间距

### 12.6 代码优化

#### 12.6.1 JavaScript 逻辑简化
**移除**：
- `spinning` 状态
- `rotation` 状态
- `startDraw()` 方法
- 转盘旋转动画逻辑
- 弹窗提示逻辑（wx.showModal）

**新增**：
- `isRevealed` 状态（控制卡片翻转）
- `handleCardClick()` 方法（点击卡片触发抽取）
- `handleReset()` 方法（重置卡片状态）

**优化**：
- 简化了状态管理
- 减少了代码行数（从 130 行减少到 90 行）
- 提高了代码可读性

#### 12.6.2 样式代码优化
- 使用更语义化的类名（`.game-card`, `.card-face`, `.card-front`, `.card-back`）
- 统一圆角、阴影、边框样式
- 采用一致的间距系统
- 使用 CSS 变量思想（虽然小程序不支持 CSS 变量，但保持了一致性）

### 12.7 与 Figma 设计稿的差异

由于微信小程序的技术限制，以下 Figma 设计稿中的功能未实现：

1. **3D 轮播动画**：
   - Figma 设计稿：使用 Canvas 实现多个卡片在 3D 空间中旋转
   - 实际实现：简化为单个卡片的 3D 翻转效果
   - 原因：Canvas 实现复杂度高，性能可能不佳，且单卡片翻转更符合小程序使用习惯

2. **Framer Motion 动画**：
   - Figma 设计稿：使用 Framer Motion 库实现流畅动画
   - 实际实现：使用原生 CSS transition
   - 原因：微信小程序不支持第三方动画库

3. **拖拽交互**：
   - Figma 设计稿：支持拖拽旋转轮播
   - 实际实现：点击交互
   - 原因：点击交互更简单直观，符合小程序使用习惯

### 12.8 文件变更清单

**修改的文件**：
- `miniprogram/pages/index/index.wxml` - 主页面结构
- `miniprogram/pages/index/index.wxss` - 主页面样式
- `miniprogram/pages/index/index.js` - 主页面逻辑
- `miniprogram/pages/list/list.wxss` - 列表页样式
- `miniprogram/pages/detail/detail.wxss` - 详情页样式

**未修改的文件**：
- `miniprogram/pages/list/list.wxml` - 列表页结构（样式已更新）
- `miniprogram/pages/list/list.js` - 列表页逻辑
- `miniprogram/pages/detail/detail.wxml` - 详情页结构（样式已更新）
- `miniprogram/pages/detail/detail.js` - 详情页逻辑
- `miniprogram/utils/api.js` - API 封装
- `server/` - 后端代码

**未创建的文件**（原计划中的）：
- `miniprogram/components/wheel/` - 转盘组件（已废弃）
- TabBar 图标资源（暂未实现 TabBar）

### 12.9 测试建议

#### 12.9.1 功能测试
- [x] 输入不同人数，验证游戏筛选逻辑
- [x] 测试卡片翻转动画是否流畅
- [x] 测试重新抽取功能
- [x] 测试快捷操作按钮跳转
- [ ] 测试无游戏时的提示
- [ ] 测试详情页的所有功能
- [ ] 测试列表页的搜索和筛选

#### 12.9.2 样式测试
- [ ] 在不同屏幕尺寸下测试布局（iPhone SE, iPhone 14 Pro Max, iPad）
- [ ] 验证所有页面的配色一致性
- [ ] 检查阴影和圆角效果
- [ ] 测试深色模式（如果支持）

#### 12.9.3 性能测试
- [ ] 测试卡片翻转动画帧率（目标 > 30fps）
- [ ] 测试页面加载时间（目标 < 2秒）
- [ ] 测试大量游戏数据的渲染性能

#### 12.9.4 兼容性测试
- [ ] 在不同微信版本中测试
- [ ] 在 iOS 设备上测试
- [ ] 在 Android 设备上测试

### 12.10 后续优化方向

1. **动画增强**：
   - 使用 `wx.createAnimation()` API 实现更复杂的动画
   - 为按钮添加 hover 和 active 状态的微动画
   - 添加页面切换动画

2. **Canvas 轮播**（可选）：
   - 如果需要实现 3D 轮播效果，可以参考 Figma 设计稿中的 `SpinWheel.tsx`
   - 使用 Canvas 2D API 绘制多个卡片
   - 实现拖拽旋转交互

3. **手势交互**：
   - 添加滑动手势来触发重新抽取
   - 添加长按手势查看详情

4. **骨架屏**：
   - 在加载游戏列表时显示骨架屏
   - 提升用户体验

5. **TabBar 实现**：
   - 添加底部导航栏
   - 准备图标资源
   - 配置 app.json

6. **性能优化**：
   - 图片懒加载
   - 列表虚拟滚动（如果游戏数量 > 100）
   - 使用 `wx.createIntersectionObserver()` 实现可见性检测

### 12.11 总结

本次改造成功将小程序的视觉风格从紫色渐变改为现代简洁的灰白色风格，并实现了 3D 翻转卡片效果。虽然由于技术限制未能完全还原 Figma 设计稿中的 3D 轮播效果，但当前的实现已经能够提供良好的用户体验，且代码更加简洁易维护。

**主要成果**：
- ✅ 完成了主页面的视觉改造
- ✅ 实现了 3D 翻转卡片效果
- ✅ 优化了交互流程
- ✅ 统一了设计系统（配色、圆角、阴影、间距）
- ✅ 简化了代码逻辑
- ✅ 更新了列表页和详情页的样式

**待完成的工作**：
- ⏳ TabBar 导航栏实现
- ⏳ 管理后台开发（阶段三）
- ⏳ 全面测试和优化
- ⏳ 云开发迁移（未来）

