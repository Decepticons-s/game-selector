# 阶段一：本地环境搭建 - 详细实施计划

## 目标
搭建完整的本地开发和测试环境，包括微信小程序项目、Node.js后端服务器和MongoDB数据库。

---

## 1. 初始化微信小程序项目

### 1.1 创建项目
- 打开微信开发者工具
- 新建小程序项目
  - 项目名称：今天玩什么
  - 目录：`/Users/free/Documents/今天玩什么`
  - AppID：使用测试号或个人AppID
  - 开发模式：小程序
  - 后端服务：不使用云服务（本地测试阶段）

### 1.2 配置项目结构
创建以下目录和文件：
```
miniprogram/
├── pages/
│   ├── index/          # 首页（转盘）
│   ├── detail/         # 游戏详情
│   ├── list/           # 游戏列表
│   └── admin/          # 管理后台
│       ├── login/
│       ├── manage/
│       └── edit/
├── components/
│   ├── wheel/          # 转盘组件
│   ├── game-card/      # 游戏卡片
│   └── player-selector/ # 人数选择器
├── utils/
│   ├── api.js          # API封装
│   ├── auth.js         # 认证工具
│   └── util.js         # 通用工具
├── images/             # 静态资源
├── app.js
├── app.json
└── app.wxss
```

### 1.3 配置 [`app.json`](miniprogram/app.json)
```json
{
  "pages": [
    "pages/index/index",
    "pages/detail/detail",
    "pages/list/list",
    "pages/admin/login/login",
    "pages/admin/manage/manage",
    "pages/admin/edit/edit"
  ],
  "window": {
    "navigationBarTitleText": "今天玩什么",
    "navigationBarBackgroundColor": "#FF6B35",
    "navigationBarTextStyle": "white",
    "backgroundColor": "#F5F5F5"
  },
  "tabBar": {
    "color": "#666666",
    "selectedColor": "#FF6B35",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "抽取",
        "iconPath": "images/tab-wheel.png",
        "selectedIconPath": "images/tab-wheel-active.png"
      },
      {
        "pagePath": "pages/list/list",
        "text": "列表",
        "iconPath": "images/tab-list.png",
        "selectedIconPath": "images/tab-list-active.png"
      }
    ]
  }
}
```

### 1.4 配置 [`project.config.json`](project.config.json)
```json
{
  "appid": "your-appid",
  "projectname": "今天玩什么",
  "miniprogramRoot": "miniprogram/",
  "setting": {
    "urlCheck": false,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "minified": true
  }
}
```

---

## 2. 搭建本地Node.js服务器

### 2.1 创建服务器目录结构
```
server/
├── src/
│   ├── routes/
│   │   ├── games.js
│   │   ├── admin.js
│   │   └── upload.js
│   ├── models/
│   │   ├── Game.js
│   │   └── Admin.js
│   ├── middleware/
│   │   └── auth.js
│   ├── config/
│   │   └── db.js
│   └── app.js
├── uploads/
│   ├── images/
│   └── videos/
├── package.json
└── .env
```

### 2.2 初始化Node.js项目
```bash
cd server
npm init -y
```

### 2.3 安装依赖包
```bash
npm install express mongoose multer cors dotenv jsonwebtoken bcryptjs
npm install --save-dev nodemon
```

依赖说明：
- `express`: Web框架
- `mongoose`: MongoDB ODM
- `multer`: 文件上传中间件
- `cors`: 跨域支持
- `dotenv`: 环境变量管理
- `jsonwebtoken`: JWT认证
- `bcryptjs`: 密码加密
- `nodemon`: 开发热重载

### 2.4 配置 [`package.json`](server/package.json)
```json
{
  "name": "game-picker-server",
  "version": "1.0.0",
  "scripts": {
    "start": "node src/app.js",
    "dev": "nodemon src/app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^8.0.0",
    "multer": "^1.4.5",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "jsonwebtoken": "^9.0.2",
    "bcryptjs": "^2.4.3"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
```

### 2.5 创建环境变量文件 [`.env`](server/.env)
```env
PORT=3000
MONGODB_URI=mongodb://localhost:27017/game-picker
JWT_SECRET=your-secret-key-change-in-production
UPLOAD_PATH=./uploads
```

### 2.6 创建数据库配置 [`db.js`](server/src/config/db.js)
```javascript
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('MongoDB connected');
  } catch (error) {
    console.error('MongoDB connection error:', error);
    process.exit(1);
  }
};

module.exports = connectDB;
```

### 2.7 创建Express应用 [`app.js`](server/src/app.js)
```javascript
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const connectDB = require('./config/db');

const app = express();

// 连接数据库
connectDB();

// 中间件
app.use(cors());
app.use(express.json());
app.use('/uploads', express.static('uploads'));

// 路由
app.use('/api/games', require('./routes/games'));
app.use('/api/admin', require('./routes/admin'));
app.use('/api/upload', require('./routes/upload'));

// 健康检查
app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

---

## 3. 配置MongoDB数据库

### 3.1 安装MongoDB
**macOS**:
```bash
brew tap mongodb/brew
brew install mongodb-community
```

**启动MongoDB服务**:
```bash
brew services start mongodb-community
```

### 3.2 验证MongoDB安装
```bash
mongosh
```

应该能成功连接到MongoDB shell。

### 3.3 创建数据库和集合
```javascript
// 在mongosh中执行
use game-picker

// 创建游戏集合
db.createCollection('games')

// 创建管理员集合
db.createCollection('admins')

// 创建索引
db.games.createIndex({ name: 1 })
db.games.createIndex({ status: 1 })
db.admins.createIndex({ openid: 1 }, { unique: true })
```

### 3.4 插入测试数据
```javascript
// 插入测试游戏
db.games.insertOne({
  name: "狼人杀",
  description: "经典的角色扮演推理游戏",
  playerCount: {
    min: 6,
    max: 18,
    optimal: [8, 9, 10, 11, 12]
  },
  tags: ["推理", "角色扮演", "语言"],
  coverImage: "",
  images: [],
  videos: [],
  difficulty: "medium",
  duration: 30,
  status: "active",
  createdAt: new Date(),
  updatedAt: new Date()
})

// 插入测试管理员（使用你的微信openid）
db.admins.insertOne({
  openid: "test-admin-openid",
  nickname: "测试管理员",
  role: "admin",
  createdAt: new Date()
})
```

---

## 4. 实现基础API接口

### 4.1 创建游戏数据模型 [`Game.js`](server/src/models/Game.js)
```javascript
const mongoose = require('mongoose');

const gameSchema = new mongoose.Schema({
  name: { type: String, required: true },
  description: { type: String, required: true },
  playerCount: {
    min: { type: Number, required: true },
    max: { type: Number, required: true },
    optimal: [Number]
  },
  tags: [String],
  coverImage: String,
  images: [String],
  videos: [{
    url: String,
    title: String,
    duration: Number
  }],
  difficulty: { type: String, enum: ['easy', 'medium', 'hard'] },
  duration: Number,
  status: { type: String, enum: ['active', 'inactive'], default: 'active' }
}, {
  timestamps: true
});

module.exports = mongoose.model('Game', gameSchema);
```

### 4.2 创建管理员数据模型 [`Admin.js`](server/src/models/Admin.js)
```javascript
const mongoose = require('mongoose');

const adminSchema = new mongoose.Schema({
  openid: { type: String, required: true, unique: true },
  nickname: String,
  role: { type: String, default: 'admin' }
}, {
  timestamps: true
});

module.exports = mongoose.model('Admin', adminSchema);
```

### 4.3 创建认证中间件 [`auth.js`](server/src/middleware/auth.js)
```javascript
const jwt = require('jsonwebtoken');
const Admin = require('../models/Admin');

const auth = async (req, res, next) => {
  try {
    const token = req.header('Authorization')?.replace('Bearer ', '');
    
    if (!token) {
      return res.status(401).json({ error: '未授权访问' });
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const admin = await Admin.findOne({ _id: decoded.id });

    if (!admin) {
      return res.status(401).json({ error: '管理员不存在' });
    }

    req.admin = admin;
    next();
  } catch (error) {
    res.status(401).json({ error: '认证失败' });
  }
};

module.exports = auth;
```

### 4.4 创建游戏路由 [`games.js`](server/src/routes/games.js)
```javascript
const express = require('express');
const router = express.Router();
const Game = require('../models/Game');
const auth = require('../middleware/auth');

// 获取游戏列表
router.get('/', async (req, res) => {
  try {
    const { playerCount, status = 'active' } = req.query;
    
    let query = { status };
    
    if (playerCount) {
      const count = parseInt(playerCount);
      query['playerCount.min'] = { $lte: count };
      query['playerCount.max'] = { $gte: count };
    }
    
    const games = await Game.find(query);
    res.json(games);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// 获取游戏详情
router.get('/:id', async (req, res) => {
  try {
    const game = await Game.findById(req.params.id);
    if (!game) {
      return res.status(404).json({ error: '游戏不存在' });
    }
    res.json(game);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// 随机抽取游戏
router.get('/random', async (req, res) => {
  try {
    const { playerCount } = req.query;
    
    let query = { status: 'active' };
    
    if (playerCount) {
      const count = parseInt(playerCount);
      query['playerCount.min'] = { $lte: count };
      query['playerCount.max'] = { $gte: count };
    }
    
    const games = await Game.find(query);
    
    if (games.length === 0) {
      return res.status(404).json({ error: '没有符合条件的游戏' });
    }
    
    const randomGame = games[Math.floor(Math.random() * games.length)];
    res.json(randomGame);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// 添加游戏（需要管理员权限）
router.post('/', auth, async (req, res) => {
  try {
    const game = new Game(req.body);
    await game.save();
    res.status(201).json(game);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// 更新游戏（需要管理员权限）
router.put('/:id', auth, async (req, res) => {
  try {
    const game = await Game.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true, runValidators: true }
    );
    
    if (!game) {
      return res.status(404).json({ error: '游戏不存在' });
    }
    
    res.json(game);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// 删除游戏（需要管理员权限）
router.delete('/:id', auth, async (req, res) => {
  try {
    const game = await Game.findByIdAndDelete(req.params.id);
    
    if (!game) {
      return res.status(404).json({ error: '游戏不存在' });
    }
    
    res.json({ message: '删除成功' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

module.exports = router;
```

### 4.5 创建管理员路由 [`admin.js`](server/src/routes/admin.js)
```javascript
const express = require('express');
const router = express.Router();
const jwt = require('jsonwebtoken');
const Admin = require('../models/Admin');
const auth = require('../middleware/auth');

// 管理员登录/注册
router.post('/login', async (req, res) => {
  try {
    const { openid, nickname } = req.body;
    
    if (!openid) {
      return res.status(400).json({ error: 'openid不能为空' });
    }
    
    let admin = await Admin.findOne({ openid });
    
    if (!admin) {
      return res.status(403).json({ error: '无管理员权限' });
    }
    
    // 更新昵称
    if (nickname && admin.nickname !== nickname) {
      admin.nickname = nickname;
      await admin.save();
    }
    
    const token = jwt.sign(
      { id: admin._id, openid: admin.openid },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );
    
    res.json({
      token,
      admin: {
        id: admin._id,
        openid: admin.openid,
        nickname: admin.nickname,
        role: admin.role
      }
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// 验证管理员身份
router.get('/check', auth, async (req, res) => {
  res.json({
    admin: {
      id: req.admin._id,
      openid: req.admin.openid,
      nickname: req.admin.nickname,
      role: req.admin.role
    }
  });
});

module.exports = router;
```

### 4.6 创建文件上传路由 [`upload.js`](server/src/routes/upload.js)
```javascript
const express = require('express');
const router = express.Router();
const multer = require('multer');
const path = require('path');
const auth = require('../middleware/auth');

// 配置文件存储
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadPath = file.mimetype.startsWith('video/') 
      ? 'uploads/videos' 
      : 'uploads/images';
    cb(null, uploadPath);
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + path.extname(file.originalname));
  }
});

// 文件过滤
const fileFilter = (req, file, cb) => {
  if (file.mimetype.startsWith('image/') || file.mimetype.startsWith('video/')) {
    cb(null, true);
  } else {
    cb(new Error('只支持图片和视频文件'), false);
  }
};

const upload = multer({
  storage,
  fileFilter,
  limits: {
    fileSize: 50 * 1024 * 1024 // 50MB
  }
});

// 上传图片
router.post('/image', auth, upload.single('file'), (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: '没有上传文件' });
    }
    
    const fileUrl = `http://localhost:${process.env.PORT}/uploads/images/${req.file.filename}`;
    res.json({ url: fileUrl });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// 上传视频
router.post('/video', auth, upload.single('file'), (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: '没有上传文件' });
    }
    
    const fileUrl = `http://localhost:${process.env.PORT}/uploads/videos/${req.file.filename}`;
    res.json({ url: fileUrl });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

module.exports = router;
```

---

## 5. 创建小程序API工具类

### 5.1 创建 [`api.js`](miniprogram/utils/api.js)
```javascript
const BASE_URL = 'http://localhost:3000/api';

const request = (url, options = {}) => {
  return new Promise((resolve, reject) => {
    const token = wx.getStorageSync('token');
    
    wx.request({
      url: BASE_URL + url,
      method: options.method || 'GET',
      data: options.data,
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      success: (res) => {
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(res.data);
        } else {
          reject(res.data);
        }
      },
      fail: reject
    });
  });
};

module.exports = {
  // 游戏相关
  getGames: (playerCount) => {
    const query = playerCount ? `?playerCount=${playerCount}` : '';
    return request(`/games${query}`);
  },
  
  getGameDetail: (id) => {
    return request(`/games/${id}`);
  },
  
  getRandomGame: (playerCount) => {
    const query = playerCount ? `?playerCount=${playerCount}` : '';
    return request(`/games/random${query}`);
  },
  
  addGame: (data) => {
    return request('/games', { method: 'POST', data });
  },
  
  updateGame: (id, data) => {
    return request(`/games/${id}`, { method: 'PUT', data });
  },
  
  deleteGame: (id) => {
    return request(`/games/${id}`, { method: 'DELETE' });
  },
  
  // 管理员相关
  adminLogin: (openid, nickname) => {
    return request('/admin/login', {
      method: 'POST',
      data: { openid, nickname }
    });
  },
  
  checkAdmin: () => {
    return request('/admin/check');
  },
  
  // 文件上传
  uploadImage: (filePath) => {
    return new Promise((resolve, reject) => {
      const token = wx.getStorageSync('token');
      
      wx.uploadFile({
        url: BASE_URL + '/upload/image',
        filePath,
        name: 'file',
        header: {
          'Authorization': token ? `Bearer ${token}` : ''
        },
        success: (res) => {
          const data = JSON.parse(res.data);
          resolve(data);
        },
        fail: reject
      });
    });
  },
  
  uploadVideo: (filePath) => {
    return new Promise((resolve, reject) => {
      const token = wx.getStorageSync('token');
      
      wx.uploadFile({
        url: BASE_URL + '/upload/video',
        filePath,
        name: 'file',
        header: {
          'Authorization': token ? `Bearer ${token}` : ''
        },
        success: (res) => {
          const data = JSON.parse(res.data);
          resolve(data);
        },
        fail: reject
      });
    });
  }
};
```

---

## 6. 测试环境

### 6.1 启动MongoDB
```bash
brew services start mongodb-community
```

### 6.2 启动Node.js服务器
```bash
cd server
npm run dev
```

应该看到：
```
Server running on port 3000
MongoDB connected
```

### 6.3 测试API接口
使用Postman或curl测试：

**获取游戏列表**:
```bash
curl http://localhost:3000/api/games
```

**健康检查**:
```bash
curl http://localhost:3000/health
```

### 6.4 在微信开发者工具中测试
1. 打开微信开发者工具
2. 打开项目
3. 在详情 → 本地设置中：
   - 勾选"不校验合法域名"
   - 勾选"不校验TLS版本"
4. 在控制台测试API调用

---

## 验收标准

- [ ] 微信小程序项目创建成功，目录结构完整
- [ ] Node.js服务器启动成功，监听3000端口
- [ ] MongoDB数据库连接成功
- [ ] 可以通过API获取游戏列表
- [ ] 可以通过API添加游戏（需要token）
- [ ] 文件上传功能正常
- [ ] 小程序可以调用本地API接口

---

## 常见问题

### Q1: MongoDB连接失败
**解决方案**: 
```bash
# 检查MongoDB服务状态
brew services list

# 重启MongoDB
brew services restart mongodb-community
```

### Q2: 小程序无法访问本地服务器
**解决方案**: 
- 确保勾选"不校验合法域名"
- 检查服务器是否启动
- 检查防火墙设置

### Q3: 文件上传失败
**解决方案**: 
- 确保 `uploads/images` 和 `uploads/videos` 目录存在
- 检查文件大小是否超过限制
- 检查文件类型是否支持

---

## 下一步
完成本阶段后，进入 **阶段二：核心功能开发**
